<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H∆∞·ªõng d·∫´n t√≠ch h·ª£p VNPay</title>
    <style>
        @page {
            margin: 2.5cm;
        }
        
        body {
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
            color: #333;
            max-width: 21cm;
            margin: 0 auto;
            padding: 20px;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #0066cc;
        }
        
        .header h1 {
            color: #0066cc;
            font-size: 24pt;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .header p {
            color: #666;
            font-size: 12pt;
            margin: 5px 0;
        }
        
        h2 {
            color: #0066cc;
            font-size: 16pt;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid #0066cc;
        }
        
        h3 {
            color: #333;
            font-size: 14pt;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .step-number {
            display: inline-block;
            background: #0066cc;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .note-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
        }
        
        .note-box strong {
            color: #856404;
        }
        
        .warning-box {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
        }
        
        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
        }
        
        .code-block {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 10pt;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .code-header {
            background: #333;
            color: white;
            padding: 8px 15px;
            border-radius: 5px 5px 0 0;
            font-family: 'Courier New', monospace;
            font-size: 10pt;
            margin-bottom: -15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th {
            background: #0066cc;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .checklist {
            list-style: none;
            padding-left: 0;
        }
        
        .checklist li {
            padding: 8px 0;
            padding-left: 30px;
            position: relative;
        }
        
        .checklist li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #28a745;
            font-weight: bold;
            font-size: 16pt;
        }
        
        .step-container {
            margin: 30px 0;
            page-break-inside: avoid;
        }
        
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #0066cc;
            text-align: center;
            color: #666;
            font-size: 10pt;
        }
        
        ol, ul {
            margin: 10px 0;
            padding-left: 30px;
        }
        
        li {
            margin: 8px 0;
        }
        
        .btn-print {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12pt;
            margin: 20px 0;
        }
        
        .btn-print:hover {
            background: #0052a3;
        }
        
        @media print {
            .btn-print {
                display: none;
            }
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <button class="btn-print" onclick="window.print()">üñ®Ô∏è In t√†i li·ªáu</button>
    
    <div class="header">
        <h1>H∆Ø·ªöNG D·∫™N T√çCH H·ª¢P THANH TO√ÅN VNPAY</h1>
        <p><strong>Cinema Booking System</strong></p>
        <p>Phi√™n b·∫£n: 1.0 | Ng√†y c·∫≠p nh·∫≠t: Th√°ng 10/2025</p>
    </div>

    <div class="step-container">
        <h2><span class="step-number">B∆Ø·ªöC 0</span>CHU·∫®N B·ªä</h2>
        
        <h3>1. ƒêƒÉng k√Ω t√†i kho·∫£n test tr√™n sandbox</h3>
        <ol>
            <li>Truy c·∫≠p: <strong>https://sandbox.vnpayment.vn/devreg</strong></li>
            <li>Ho√†n th√†nh th√¥ng tin ƒëƒÉng k√Ω theo h∆∞·ªõng d·∫´n</li>
            <li>Ki·ªÉm tra email ƒë·ªÉ nh·∫≠n th√¥ng tin t√†i kho·∫£n</li>
        </ol>

        <h3>2. L·∫•y th√¥ng tin c·∫•u h√¨nh</h3>
        <p>T·ª´ email x√°c nh·∫≠n VNPay, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c:</p>
        <ul>
            <li><strong>vnp_TmnCode</strong>: M√£ ƒë·ªãnh danh merchant</li>
            <li><strong>vnp_HashSecret</strong>: Kh√≥a b√≠ m·∫≠t t·∫°o ch·ªØ k√Ω b·∫£o m·∫≠t</li>
        </ul>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Quan tr·ªçng:</strong> L∆∞u tr·ªØ th√¥ng tin n√†y c·∫©n th·∫≠n v√† kh√¥ng chia s·∫ª v·ªõi b·∫•t k·ª≥ ai!
        </div>
    </div>

    <div class="step-container">
        <h2><span class="step-number">B∆Ø·ªöC 1</span>C·∫§U H√åNH FILE .ENV</h2>
        
        <p>Th√™m c√°c c·∫•u h√¨nh sau v√†o file <code>.env</code> c·ªßa d·ª± √°n:</p>
        
        <div class="code-header">üìÑ .env</div>
        <div class="code-block"># VNPay Configuration
VNPAY_TMN_CODE=your_tmn_code_here
VNPAY_HASH_SECRET_KEY=your_secret_key_here
VNPAY_PAYMENT_URL=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
VNPAY_RETURN_URL=http://localhost:3000/payment/return</div>

        <div class="note-box">
            <strong>üìù L∆∞u √Ω:</strong> Thay <code>your_tmn_code_here</code> v√† <code>your_secret_key_here</code> b·∫±ng th√¥ng tin th·ª±c t·∫ø t·ª´ VNPay.
        </div>
    </div>

    <div class="step-container">
        <h2><span class="step-number">B∆Ø·ªöC 2</span>C·∫§U TR√öC FILE V√Ä SCHEMAS</h2>
        
        <h3>2.1. Payment Schemas</h3>
        <p>T·∫°o file: <code>app/schemas/payments.py</code></p>
        
        <div class="code-header">üêç app/schemas/payments.py</div>
        <div class="code-block">from pydantic import BaseModel
from typing import Optional
from enum import Enum

class PaymentStatus(str, Enum):
    PENDING = "pending"
    SUCCESS = "success"
    FAILED = "failed"
    CANCELLED = "cancelled"

class PaymentMethod(str, Enum):
    VNPAY = "vnpay"
    CASH = "cash"

class PaymentRequest(BaseModel):
    """Y√™u c·∫ßu thanh to√°n"""
    order_id: str           # M√£ ƒë∆°n h√†ng (unique)
    amount: int            # S·ªë ti·ªÅn VND
    order_desc: str        # M√¥ t·∫£ ƒë∆°n h√†ng
    bank_code: Optional[str] = None  # M√£ ng√¢n h√†ng (optional)
    language: str = "vn"   # Ng√¥n ng·ªØ (vn/en)

class PaymentResponse(BaseModel):
    """Ph·∫£n h·ªìi thanh to√°n"""
    payment_url: str       # URL thanh to√°n VNPay
    order_id: str         # M√£ ƒë∆°n h√†ng

class PaymentResult(BaseModel):
    """K·∫øt qu·∫£ thanh to√°n"""
    success: bool
    order_id: str
    transaction_id: Optional[str] = None
    amount: Optional[int] = None
    message: str
    payment_method: PaymentMethod
    payment_status: PaymentStatus</div>
    </div>

    <div class="step-container">
        <h2><span class="step-number">B∆Ø·ªöC 3</span>API ENDPOINTS</h2>
        
        <h3>3.1. Endpoint t·∫°o thanh to√°n</h3>
        <p>T·∫°o file: <code>app/api/v1/payments.py</code></p>
        
        <div class="code-header">üêç app/api/v1/payments.py - Create Payment</div>
        <div class="code-block">from fastapi import APIRouter, Depends, HTTPException, Request
from sqlalchemy.orm import Session
from app.core.database import get_db
from app.services.payments_service import PaymentService
from app.schemas.payments import PaymentRequest, PaymentResponse

router = APIRouter()
payment_service = PaymentService()

@router.post("/vnpay/create-payment", response_model=PaymentResponse)
async def create_vnpay_payment(
    payment_request: PaymentRequest,
    request: Request,
    db: Session = Depends(get_db)
):
    """
    T·∫°o URL thanh to√°n VNPay
    
    Body request:
    {
        "order_id": "ORDER123456",
        "amount": 100000,
        "order_desc": "Thanh to√°n v√© xem phim",
        "bank_code": "NCB",  // Optional
        "language": "vn"
    }
    """
    try:
        client_ip = request.client.host
        
        # T·∫°o b·∫£n ghi thanh to√°n trong DB
        payment_service.create_payment_record(
            db=db,
            order_id=payment_request.order_id,
            amount=payment_request.amount,
            payment_method="vnpay",
            order_desc=payment_request.order_desc,
            client_ip=client_ip
        )
        
        # T·∫°o URL thanh to√°n VNPay
        payment_response = payment_service.create_vnpay_payment_url(
            payment_request, client_ip
        )
        
        return payment_response
        
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=500, 
            detail=f"Internal server error: {str(e)}"
        )</div>

        <h3>3.2. Endpoint x·ª≠ l√Ω callback t·ª´ VNPay</h3>
        
        <div class="code-header">üêç app/api/v1/payments.py - Callback Handlers</div>
        <div class="code-block">@router.get("/vnpay/return")
async def vnpay_return_callback(
    request: Request,
    db: Session = Depends(get_db)
):
    """Callback khi user quay v·ªÅ t·ª´ VNPay"""
    try:
        query_params = dict(request.query_params)
        
        payment_result = payment_service.handle_vnpay_callback(query_params)
        
        payment_service.update_payment_status(
            db, payment_result.order_id, payment_result
        )
        
        return payment_result
        
    except Exception as e:
        raise HTTPException(
            status_code=500, 
            detail=f"Internal server error: {str(e)}"
        )

@router.post("/vnpay/ipn")
async def vnpay_ipn_callback(
    request: Request,
    db: Session = Depends(get_db)
):
    """IPN callback t·ª´ VNPay server"""
    try:
        query_params = dict(request.query_params)
        
        payment_result = payment_service.handle_vnpay_callback(query_params)
        payment_service.update_payment_status(
            db, payment_result.order_id, payment_result
        )
        
        if payment_result.success:
            return JSONResponse(
                content={'RspCode': '00', 'Message': 'success'},
                status_code=200
            )
        else:
            return JSONResponse(
                content={'RspCode': '99', 'Message': 'Unknown error'},
                status_code=200
            )
            
    except Exception as e:
        return JSONResponse(
            content={'RspCode': '99', 'Message': 'Unknown error'},
            status_code=200
        )</div>
    </div>

    <div class="step-container">
        <h2><span class="step-number">B∆Ø·ªöC 4</span>PAYMENT SERVICE</h2>
        
        <h3>4.1. Service x·ª≠ l√Ω logic</h3>
        <p>T·∫°o file: <code>app/services/payments_service.py</code></p>
        
        <div class="code-header">üêç app/services/payments_service.py</div>
        <div class="code-block">from app.core.config import settings
from app.payments.vnpay import VNPay
from app.schemas.payments import PaymentRequest, PaymentResponse
from datetime import datetime

class PaymentService:
    """Service x·ª≠ l√Ω thanh to√°n"""
    
    def __init__(self):
        self.vnpay = VNPay()
    
    def create_vnpay_payment_url(
        self, 
        payment_request: PaymentRequest, 
        client_ip: str
    ) -> PaymentResponse:
        """T·∫°o URL thanh to√°n VNPay"""
        try:
            self.vnpay.set_request_data(
                vnp_Version='2.1.0',
                vnp_Command='pay',
                vnp_TmnCode=settings.VNPAY_TMN_CODE,
                vnp_Amount=payment_request.amount * 100,  # VNPay * 100
                vnp_CurrCode='VND',
                vnp_TxnRef=payment_request.order_id,
                vnp_OrderInfo=payment_request.order_desc,
                vnp_OrderType='other',
                vnp_Locale=payment_request.language,
                vnp_CreateDate=datetime.now().strftime('%Y%m%d%H%M%S'),
                vnp_IpAddr=client_ip,
                vnp_ReturnUrl=settings.VNPAY_RETURN_URL
            )
            
            if payment_request.bank_code:
                self.vnpay.set_request_data(vnp_BankCode=payment_request.bank_code)
            
            payment_url = self.vnpay.get_payment_url(
                settings.VNPAY_PAYMENT_URL,
                settings.VNPAY_HASH_SECRET_KEY
            )
            
            return PaymentResponse(
                payment_url=payment_url,
                order_id=payment_request.order_id
            )
            
        except Exception as e:
            raise HTTPException(
                status_code=500, 
                detail=f"Failed to create payment URL: {str(e)}"
            )
    
    def handle_vnpay_callback(self, callback_data: Dict[str, Any]) -> PaymentResult:
        """X·ª≠ l√Ω callback t·ª´ VNPay"""
        self.vnpay.set_response_data(callback_data)
        is_valid = self.vnpay.validate_response(settings.VNPAY_HASH_SECRET_KEY)
        
        if not is_valid:
            return PaymentResult(
                success=False,
                order_id=callback_data.get('vnp_TxnRef', ''),
                message="Invalid signature",
                payment_method=PaymentMethod.VNPAY,
                payment_status=PaymentStatus.FAILED
            )
        
        response_code = callback_data.get('vnp_ResponseCode')
        if response_code == '00':
            status = PaymentStatus.SUCCESS
            message = "Payment successful"
            success = True
        else:
            status = PaymentStatus.FAILED
            message = f"Payment failed with code: {response_code}"
            success = False
        
        return PaymentResult(
            success=success,
            order_id=callback_data.get('vnp_TxnRef'),
            transaction_id=callback_data.get('vnp_TransactionNo'),
            amount=int(callback_data.get('vnp_Amount', 0)) // 100,
            message=message,
            payment_method=PaymentMethod.VNPAY,
            payment_status=status
        )</div>
    </div>

    <div class="step-container">
        <h2><span class="step-number">B∆Ø·ªöC 5</span>TESTING</h2>
        
        <h3>5.1. Test t·∫°o thanh to√°n</h3>
        
        <div class="code-header">üíª cURL Command</div>
        <div class="code-block">curl -X POST "http://localhost:8000/api/v1/payments/vnpay/create-payment" \
-H "Content-Type: application/json" \
-d '{
    "order_id": "ORDER123456",
    "amount": 100000,
    "order_desc": "Thanh to√°n v√© xem phim Avengers",
    "language": "vn"
}'</div>

        <h3>5.2. Response m·∫´u</h3>
        
        <div class="code-header">üì¶ JSON Response</div>
        <div class="code-block">{
    "payment_url": "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html?vnp_Amount=10000000&vnp_Command=pay&...",
    "order_id": "ORDER123456"
}</div>

        <h3>5.3. Test cases quan tr·ªçng</h3>
        <ul class="checklist">
            <li>T·∫°o thanh to√°n th√†nh c√¥ng</li>
            <li>X·ª≠ l√Ω callback return</li>
            <li>X·ª≠ l√Ω callback IPN</li>
            <li>Validate signature</li>
            <li>X·ª≠ l√Ω l·ªói payment failed</li>
        </ul>
    </div>

    <div class="step-container">
        <h2><span class="step-number">B∆Ø·ªöC 6</span>PRODUCTION CHECKLIST</h2>
        
        <h3>6.1. Thay ƒë·ªïi URL production</h3>
        
        <div class="code-header">üìÑ .env (Production)</div>
        <div class="code-block">VNPAY_PAYMENT_URL=https://vnpayment.vn/paymentv2/vpcpay.html
VNPAY_RETURN_URL=https://your-domain.com/payment/return</div>

        <h3>6.2. Security checklist</h3>
        <ul class="checklist">
            <li>Validate signature cho m·ªçi callback</li>
            <li>L∆∞u tr·ªØ secret key an to√†n</li>
            <li>Log t·∫•t c·∫£ transaction</li>
            <li>Implement timeout cho request</li>
            <li>Rate limiting cho API endpoints</li>
        </ul>

        <h3>6.3. Monitoring</h3>
        <ul>
            <li>Transaction logs</li>
            <li>Payment success rate</li>
            <li>Response time monitoring</li>
            <li>Error rate tracking</li>
        </ul>
    </div>

    <div class="step-container">
        <h2>PH·ª§ L·ª§C: M√É RESPONSE CODE VNPAY</h2>
        
        <table>
            <thead>
                <tr>
                    <th>M√£ Code</th>
                    <th>√ù nghƒ©a</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>00</strong></td>
                    <td>Giao d·ªãch th√†nh c√¥ng</td>
                </tr>
                <tr>
                    <td><strong>07</strong></td>
                    <td>Tr·ª´ ti·ªÅn th√†nh c√¥ng, giao d·ªãch b·ªã nghi ng·ªù</td>
                </tr>
                <tr>
                    <td><strong>09</strong></td>
                    <td>Giao d·ªãch kh√¥ng th√†nh c√¥ng do th·∫ª ch∆∞a ƒëƒÉng k√Ω</td>
                </tr>
                <tr>
                    <td><strong>10</strong></td>
                    <td>Giao d·ªãch kh√¥ng th√†nh c√¥ng do nh·∫≠p sai OTP</td>
                </tr>
                <tr>
                    <td><strong>11</strong></td>
                    <td>Giao d·ªãch kh√¥ng th√†nh c√¥ng do h·∫øt h·∫°n ch·ªù thanh to√°n</td>
                </tr>
                <tr>
                    <td><strong>12</strong></td>
                    <td>Giao d·ªãch kh√¥ng th√†nh c√¥ng do th·∫ª b·ªã kh√≥a</td>
                </tr>
                <tr>
                    <td><strong>24</strong></td>
                    <td>Giao d·ªãch kh√¥ng th√†nh c√¥ng do kh√°ch h√†ng h·ªßy</td>
                </tr>
            </tbody>
        </table>

        <div class="success-box">
            <strong>üìö T√†i li·ªáu ƒë·∫ßy ƒë·ªß:</strong> 
            <a href="https://sandbox.vnpayment.vn/apis/docs/huong-dan-tich-hop/" target="_blank">
                https://sandbox.vnpayment.vn/apis/docs/huong-dan-tich-hop/
            </a>
        </div>
    </div>

    <div class="footer">
        <p><strong>Cinema Booking System - VNPay Integration Guide</strong></p>
        <p>¬© 2025 | T√†i li·ªáu k·ªπ thu·∫≠t n·ªôi b·ªô</p>
        <p>ƒê·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£, vui l√≤ng li√™n h·ªá team Backend</p>
    </div>
</body>
</html>
